# This file is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, 
# either express or implied. See the License for the specific language governing permissions 
# and limitations under the License.
#
# Atlantis for AWS SAM Deployments
# Adapted from Starter 01 - Basic API Gateway and Lambda using Python
# Author: Chad Kluck - 63klabs.net/chadkluck.me
# Version: v0.0.1/2025-11-06

# Documentation, Issues/Feature Requests, Latest Updates, and Security Reports on GitHub:
# https://github.com/chadkluck/serverless-video-converter

# USE WITH:
# - atlantis/v2/pipeline/template.yml

AWSTemplateFormatVersion: "2010-09-09"
Transform:
  - AWS::Serverless-2016-10-31
  - AWS::LanguageExtensions
Description: "AWS Lambda (Python) function triggered when a new video is uploaded to S3. The Lambda function then submits a job to AWS Elemental MediaConvert"

# =============================================================================
# META DATA
# -----------------------------------------------------------------------------
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudformation-interface.html
# 

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - 
        Label:
          default: "Application Resource Naming"
        Parameters:
          - Prefix
          - ProjectId
          - StageId
          - S3BucketNameOrgPrefix
          - RolePath
          - PermissionsBoundaryArn
      -
        Label:
          default: "Deployment Environment Information"
        Parameters:
          - DeployEnvironment
          - FunctionGradualDeploymentType
          - DeployRole
      -
        Label:
          default: "External Resources and Alarm Notifications"
        Parameters:
          - ParameterStoreHierarchy
          - AlarmNotificationEmail
          - VideoOutputBucket
          - VideoOutputPrefix
          - S3LogBucketName
      -
        Label:
          default: "Lambda Function Settings"
        Parameters:
          - FunctionTimeOutInSeconds
          - FunctionMaxMemoryInMB
      -
        Label:
          default: "Application Parameters"
        Parameters:
          - LogRetentionInDaysForPROD
          - LogRetentionInDaysForDEVTEST

# =============================================================================
# PARAMETERS
# -----------------------------------------------------------------------------
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html
#

Parameters:

  # ---------------------------------------------------------------------------
  # Application Resource Naming

  Prefix:
    Type: String
    Description: "Prefix pre-pended to all resources. This can be thought of as a Name Space used to identify ownership/access for teams, departments, etc. For example, resources named ws-* could belong to the web service team and could have IAM permissions to allow access to other ws-* resources. The Prefix must have a corresponding CloudFormation Service Role. Short, descriptive 2-6 character values work best. Due to resource naming length restrictions, length of Prefix + Project ID should not exceed 28 characters. Resources are named <Prefix>-<ProjectId>-<StageId>-<ResourceId>"
    Default: "acme" 
    AllowedPattern: "^[a-z][a-z0-9-]{0,6}[a-z0-9]$"
    MinLength: 2
    MaxLength: 8
    ConstraintDescription: "2 to 8 characters. Lower case alphanumeric and dashes. Must start with a letter and end with a letter or number. Length of Prefix + Project ID should not exceed 28 characters."

  ProjectId:
    Type: String
    Description: "This is the Project or Application Identifier. If you receive 'S3 bucket name too long' errors during stack creation, then you must shorten the Project ID or use an S3 Org Prefix. Due to resource naming length restrictions, length of Prefix + Project ID should not exceed 28 characters. Resources are named <Prefix>-<ProjectId>-<StageId>-<ResourceId>"
    AllowedPattern: "^[a-z][a-z0-9-]{0,24}[a-z0-9]$"
    MinLength: 2
    MaxLength: 26
    ConstraintDescription: "Minimum of 2 characters (suggested maximum of 20). Lower case alphanumeric and dashes. Must start with a letter and end with a letter or number. Length of Prefix + Project ID should not exceed 28 characters."

  StageId:
    Type: String
    Description: "This is an alias for the branch. It does not need to match CodeCommitBranch or DeployEnvironment. Due to resource naming restrictions you can use this to provide shorter names without special characters that are allowed in branch names. For example if you have a 'test/feature-98' branch, you could use 'tf98' as the StageId. Resources are named <Prefix>-<ProjectId>-<StageId>-<ResourceId>"
    AllowedPattern: "^[a-z][a-z0-9-]{0,6}[a-z0-9]$"
    MinLength: 2
    MaxLength: 8
    ConstraintDescription: "2 to 8 characters. Lower case alphanumeric and dashes. Must start with a letter and end with a letter or number."

  S3BucketNameOrgPrefix:
    Type: String
    Description: "By default, to enforce uniqueness, buckets include account and region in the bucket name. However, due to character limits, you can specify your own S3 prefix (like an org code). This will be used in addition to the Prefix entered above. Note that this length is shared with the recommended length of 20 characters for Resource Identifiers. So if you have a 10 character S3BucketNameOrgPrefix, you are limited to 10 characters for your bucket name identifier in your templates. Buckets are named <Prefix>-<Region>-<AccountId>-<ProjectId>-<StageId>-<ResourceId> or <S3OrgPrefix>-<Prefix>-<ProjectId>-<StageId>-<ResourceId>"
    Default: ""
    AllowedPattern: "^[a-z0-9][a-z0-9-]{0,18}[a-z0-9]$|^$"
    ConstraintDescription: "May be empty or 2 to 20 characters (8 or less recommended). Lower case alphanumeric and dashes. Must start and end with a letter or number."

  RolePath:
    Type: String
    Description: "Path to use for IAM Roles and Policies. You may wish to separate out your applications from users, or create separate paths per prefix or application. Specific paths may required by permission boundaries. Ex: /ws-hello-world-test/ or /app_role/"
    Default: "/"
    AllowedPattern: "^\\/([a-zA-Z0-9-_]+[\\/])+$|^\\/$"
    ConstraintDescription: "May only contain alphanumeric characters, forward slashes, underscores, and dashes. Must begin and end with a slash."

  PermissionsBoundaryArn:
    Type: String
    Description: "Permissions Boundary is a policy attached to a role to further restrict the permissions of the role. Your organization may or may not require boundaries. If left empty, no permissions boundary will be used."
    Default: ""
    AllowedPattern: "^$|^arn:aws:iam::\\d{12}:policy\\/[\\w+=,.@\\-\\/]*[\\w+=,.@\\-]+$"
    ConstraintDescription: "Must be empty or a valid IAM Policy ARN in the format: arn:aws:iam::{account_id}:policy/{policy_name}"

  ParameterStoreHierarchy:
    Type: String
    Description: "Parameters specific to the application may be organized within a hierarchy based on your organizational or operations structure. For example, /Finance/ops/ for this value would then generate /Finance/ops/<DeployEnvironment>/<Prefix>-<ProjectId>-<StageId>/<parameterName>. Must either be a single '/' or begin and end with a '/'."
    Default: "/"
    AllowedPattern: "^\\/([a-zA-Z0-9_.\\-]*[\\/])+$|^\\/$"
    ConstraintDescription: "Must only contain alpha-numeric, dashes, underscores, or slashes. Must be a single slash or begin and end with a slash. (/Finance/, /Finance/ops/, or /)"
    
  # ---------------------------------------------------------------------------
  # Deployment Environment Identification

  DeployEnvironment:
    Type: String
    Description: "What deploy/testing environment will this run under? An environment can contain multiple stages (for example 'test' and 't98' would be in 'TEST' environment, and 'beta' and 'prod' stages would deploy to 'PROD'). Utilize this environment variable to determine your tests, app logging levels, and conditionals in the template. For example, PROD will use gradual deployment while DEV and TEST is AllAtOnce. Other resources, such as dashboards and alarms  (which cost money) could be created in PROD and not DEV or TEST. Suggested use: DEV for local SAM deployment, TEST for test/QA deployments, PROD for stage, beta, and main/prod deployments."
    Default: "PROD"
    AllowedValues: ["DEV", "TEST", "PROD"]
    ConstraintDescription: "Must specify DEV, TEST, or PROD."

  FunctionGradualDeploymentType:
    Type: String
    Description: "For production environments, what method do you want to use to gradually deploy before rolling back in case of errors. Note that when 'DeployEnvironment' is TEST or DEV, gradual deploy will not be enabled and will be same as All At Once"
    Default: "Linear10PercentEvery3Minutes"
    AllowedValues:
      - "Canary10Percent5Minutes" # Canary = First 10%, then after x minutes, full 90% (full deploy after x minutes)
      - "Canary10Percent10Minutes"
      - "Canary10Percent15Minutes"
      - "Canary10Percent30Minutes"
      - "Linear10PercentEvery1Minute" # Linear = Total of 10 deploys every x minutes: 10%, wait x minutes, another 10%, wait, 10%.... (full deploy after 10 * x minutes)
      - "Linear10PercentEvery2Minutes"
      - "Linear10PercentEvery3Minutes"
      - "Linear10PercentEvery10Minutes"
      - "AllAtOnce" # All at once. Recommended only for TEST and DEV environments.

  DeployRole:
    Type: String
    Description: "IAM role to allow AWS CodeDeploy to manage deployment of AWS Lambda functions"

  # ---------------------------------------------------------------------------
  # External Resources and Alarm Notifications

  AlarmNotificationEmail:
    Type: String
    Description: "Email address to send notifications to when alarms are triggered. Be sure to check the inbox as you will need to confirm the subscription."
    AllowedPattern: "^[\\w\\-\\.]+@([\\w\\-]+\\.)+[\\w\\-]{2,4}$"
    ConstraintDescription: "A valid email address"

  VideoOutputBucket:
    Type: CommaDelimitedList
    Description: "S3 Bucket name(s) where converted videos will be stored. Multiple buckets can be specified as comma-separated values."
    # AllowedPattern: "^[a-z0-9][a-z0-9.\\-]{1,61}[a-z0-9]$"
    # ConstraintDescription: "Comma-separated list of S3 bucket names. Each bucket: 3 to 63 characters, lowercase alphanumeric, periods, and dashes. Must start and end with letter or number."

  VideoOutputPrefix:
    Type: String
    Description: "S3 Prefix (folder) within the output bucket where converted videos will be stored."
    Default: "/"
    AllowedPattern: "^\\/([a-zA-Z0-9-_]+[\\/])+$|^\\/$"
    MaxLength: 128
    ConstraintDescription: "0 to 128 characters. Alphanumeric, hyphens, underscores, periods, and slashes. Must be a single slash or start and end with a slash."

  S3LogBucketName:
    Type: String
    Description: "The name of the S3 bucket used for logging. This is a required parameter for the S3 bucket."
    Default: ""
    AllowedPattern: "^[a-z0-9][a-z0-9-]{1,61}[a-z0-9]$|^$"
    ConstraintDescription: "Must be a valid S3 bucket name or empty. Must be between 3 and 63 characters long. Lower case alphanumeric and dashes. Must start and end with a letter or number."

  # ---------------------------------------------------------------------------
  # Lambda Function Settings

  FunctionTimeOutInSeconds:
    Type: Number
    Description: "Time out in seconds for the Lambda function. API Gateway times out after 30 seconds. This web service is ideal for requests that can complete in less than 10 seconds"
    Default: 10
    MinValue: 3
    MaxValue: 30

  FunctionMaxMemoryInMB:
    Type: Number
    Description: "If you are handling large responses, you will need to increase the size. Monitor CloudWatch logs. 1024 MB is a good starting point for most API web service applications."
    Default: 1024 # 1 GB
    MinValue: 128
    MaxValue: 10240 # 10 GB
    ConstraintDescription: "Must be between 128 and 10240 MB (10 GB). 1024 MB is a good starting point for most API web service applications."

  FunctionArchitecture:
    Type: String
    Description: "The instruction set architecture for the Lambda function. Lambda functions support x86_64 and arm64 architectures. arm64 has better processing than default x86_64 - but the layers and binaries you use must support it."
    Default: "arm64"
    AllowedValues: ["x86_64", "arm64"]

  # ---------------------------------------------------------------------------
  # Application Parameters

  LogRetentionInDaysForPROD:
    Type: Number
    Description: "How long should CloudWatch logs be kept in a PRODUCTION environment?"
    Default: 90
    AllowedValues: [1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653]

  LogRetentionInDaysForDEVTEST:
    Type: Number
    Description: "How long should CloudWatch logs be kept in a DEV or TEST environment?"
    Default: 7
    AllowedValues: [1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653]

# =============================================================================
# CONDITIONS
# -----------------------------------------------------------------------------
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-conditions.html
#

Conditions:
  IsProduction: !Equals [!Ref DeployEnvironment, "PROD"]
  # IsNotProduction: !Not [!Equals [!Ref DeployEnvironment, "PROD"]]
  IsNotDevelopment: !Not [!Equals [!Ref DeployEnvironment, "DEV"]]
  # IsTest: !Equals [!Ref DeployEnvironment, "TEST"]
  # IsDevelopment: !Equals [!Ref DeployEnvironment, "DEV"]
  # CreateProdResources: !Equals [!Ref DeployEnvironment, "PROD"]
  # CreateTestResources: !Equals [!Ref DeployEnvironment, "TEST"]
  # CreateDevResources: !Equals [!Ref DeployEnvironment, "DEV"]
  UseS3BucketNameOrgPrefix: !Not [!Equals [!Ref S3BucketNameOrgPrefix, ""]]
  HasPermissionsBoundaryArn: !Not [!Equals [!Ref PermissionsBoundaryArn, ""]]
  CreateAlarms: !Equals [!Ref DeployEnvironment, "PROD"] 
  # IsArmArch: !Equals [!Ref FunctionArchitecture, "arm64"]
  HasLoggingBucket: !Not [!Equals [!Ref S3LogBucketName, ""]]


# =============================================================================
# GLOBALS
# -----------------------------------------------------------------------------
# https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-specification-template-anatomy-globals.html
#

Globals:

  Function:
    PropagateTags: True
    Tracing: !If [ IsNotDevelopment, "Active", !Ref 'AWS::NoValue'] # X-Ray

  # StateMachine:
  #   PropagateTags: True

# =============================================================================
# RESOURCES
# -----------------------------------------------------------------------------
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/resources-section-structure.html  
#

Resources:

  # ---------------------------------------------------------------------------
  # Lambda Function Resources

  # -- Lambda Function --
  SubmitJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${Prefix}-${ProjectId}-${StageId}-SubmitJobFunction'
      Description: "Submits jobs to Media Converter"
      Role: !GetAtt LambdaExecutionRole.Arn
      PropagateTags: True

      VersionDescription: "Development Stages"
      AutoPublishCodeSha256: "20251106T0936" # Hash This To Overcome AliasLive Update Errors - Undocumented AWS bug workaround
      AutoPublishAlias: live
      DeploymentPreference:
        Enabled: !If [ IsProduction, True,  False] # Gradual deployment only if in production so DEV and TEST aren't hindered
        Type: !If [ IsProduction, !Ref FunctionGradualDeploymentType, "AllAtOnce"]
        Role: !Ref DeployRole
        Alarms:
          Fn::If:
            - CreateAlarms
            - - !Ref SubmitJobFunctionErrorsAlarm
            - - !Ref 'AWS::NoValue'

      CodeUri: src/
      Handler: index.handler
      Runtime: python3.13 # https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html
      Architectures:
        - !Ref FunctionArchitecture # arm64 has better processing than default x86_64 - but layers and binaries must support
      Timeout: !Ref FunctionTimeOutInSeconds
      MemorySize: !Ref FunctionMaxMemoryInMB

      Environment:
        Variables:
          DEPLOY_ENVIRONMENT: !Ref DeployEnvironment # PROD, TEST, DEV - a different category of environment
          LOG_LEVEL: !If [ IsProduction, "INFO",  "DEBUG"] # 20 for prod, 10 for non-prod (used by logging library)
          PARAM_STORE_PATH: !Ref ParameterStoreHierarchy # Path to instance specific params /Finance/ops/PROD/acme-myapp-prod/
          LAMBDA_TIMEOUT_IN_SEC: !Ref FunctionTimeOutInSeconds # so we can calculate any external connection timeout in our code

          MEDIA_CONVERT_ROLE: !Sub "arn:aws:iam::${AWS::AccountId}:role${RolePath}${Prefix}-${ProjectId}-${StageId}-MediaConvertRole" # Prevent Circular Reference
          VIDEO_OUTPUT_BUCKET: !Join [",", !Ref VideoOutputBucket] # S3 Bucket to store converted videos
          VIDEO_OUTPUT_PREFIX: !Ref VideoOutputPrefix # S3 Prefix (folder) within the output bucket where converted videos will be stored

  # -- LambdaFunction Execution Role --
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${Prefix}-${ProjectId}-${StageId}-LambdaExecRole"
      Description: "IAM Role that allows the Lambda function permission to execute and access resources"
      Path: !Ref RolePath
      PermissionsBoundary: !If [HasPermissionsBoundaryArn, !Ref PermissionsBoundaryArn, !Ref 'AWS::NoValue' ]
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: [lambda.amazonaws.com]
          Action: sts:AssumeRole

      # These are the resources your Lambda function needs access to Logs, SSM Parameters, DynamoDb, S3, etc.
      # Define specific actions such as get/put (read/write). Work towards practicing the Principle of Least Privilege
      Policies:
      - PolicyName: !Sub "${Prefix}-${ProjectId}-${StageId}-ExecutionPolicy"
        PolicyDocument:
          Statement:

          - Sid: LambdaAccessToWriteLogs
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Effect: Allow
            Resource: !GetAtt AppLogGroup.Arn

          - Sid: PassMediaConvertRole
            Action:
            - iam:PassRole
            Effect: Allow
            Resource: !Sub "arn:aws:iam::${AWS::AccountId}:role${RolePath}${Prefix}-${ProjectId}-${StageId}-MediaConvertRole" # Prevent Circular Reference
          
          - Sid: MediaConvertService
            Action:
            - mediaconvert:CreateJob
            - mediaconvert:DescribeEndpoints
            - mediaconvert:GetJob
            Effect: Allow
            Resource: "*"

          - Sid: S3ReadObjectTags
            Action:
            - s3:GetObjectTagging
            Effect: Allow
            Resource: !Join # Prevent Circular Reference
            - "-"
            - - !If [UseS3BucketNameOrgPrefix, !Sub "arn:aws:s3:::${S3BucketNameOrgPrefix}-${Prefix}", !Sub "arn:aws:s3:::${Prefix}" ]
              - !Sub "${ProjectId}-${StageId}-${AWS::Region}-${AWS::AccountId}-src/uploads/*"

  # -- Lambda Function Error Alarm --

  SubmitJobFunctionErrorsAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Condition: CreateAlarms # Either PROD or ALWAYS - Check Conditions
    Properties:
      AlarmDescription: Lambda Function Error > 1
      MetricName: Errors
      Statistic: Sum
      ComparisonOperator: GreaterThanThreshold
      Threshold: 1
      Period: 900
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref SubmitJobFunction
      AlarmActions:
        - Ref: SubmitJobFunctionErrorAlarmNotification

  # -- Lambda Function Notification for Error Alarm --

  SubmitJobFunctionErrorAlarmNotification:
      Type: AWS::SNS::Topic
      Condition: CreateAlarms
      Properties: 
        DisplayName: !Sub 'AWS-Alarm-${Prefix}-${ProjectId}-${StageId}'
        FifoTopic: false
        Subscription:
          - Endpoint: !Ref AlarmNotificationEmail
            Protocol: 'email'

  # -- Lambda Log Group with a retention policy --
  AppLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties: 
        LogGroupName: !Sub '/aws/lambda/${Prefix}-${ProjectId}-${StageId}-SubmitJobFunction' # Avoid circular reference !Sub "/aws/lambda/${SubmitJobFunction}"
        RetentionInDays: !If [ IsProduction, !Ref LogRetentionInDaysForPROD,  !Ref LogRetentionInDaysForDEVTEST]

  # ---------------------------------------------------------------------------
  # Media Convert Role to Pass

  MediaConvertRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${Prefix}-${ProjectId}-${StageId}-MediaConvertRole"
      Description: "IAM Role that Lambda passes with a job submission to MediaConvert so it has access to the VideoSource and VideoOutput buckets"
      Path: !Ref RolePath
      PermissionsBoundary: !If [HasPermissionsBoundaryArn, !Ref PermissionsBoundaryArn, !Ref 'AWS::NoValue' ]
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: [mediaconvert.amazonaws.com]
          Action: sts:AssumeRole

      # These are the resources your Lambda function needs access to Logs, SSM Parameters, DynamoDb, S3, etc.
      # Define specific actions such as get/put (read/write). Work towards practicing the Principle of Least Privilege
      Policies:
      - PolicyName: !Sub "${Prefix}-${ProjectId}-${StageId}-MediaConvertExecutionPolicy"
        PolicyDocument:
          Statement:

          - Sid: AccessToS3SourceBucket
            Action:
            - s3:GetObject
            - s3:GetBucketLocation
            Effect: Allow
            Resource:
            - !Sub "arn:aws:s3:::${VideoSourceBucket}"
            - !Sub "arn:aws:s3:::${VideoSourceBucket}/uploads/*"

          - Sid: "AccessToS3DestinationBucket"
            Action:
            - s3:PutObject
            - s3:PutObjectAcl
            - s3:GetBucketLocation
            Effect: Allow
            Resource:
              'Fn::ForEach::S3DestinationBuckets':
                - BucketName
                - !Ref VideoOutputBucket
                - 'S3DestinationBuckets${BucketName}':
                  - !Sub "arn:aws:s3:::${BucketName}"
                  - !Sub "arn:aws:s3:::${BucketName}${VideoOutputPrefix}*"

  # ---------------------------------------------------------------------------
  # Source Bucket

  VideoSourceBucket:
    Type: AWS::S3::Bucket
    DependsOn: 
      - S3LambdaPermission
    Properties:
      BucketName: !Join
        - "-"
        - - !If [UseS3BucketNameOrgPrefix, !Sub "${S3BucketNameOrgPrefix}-${Prefix}", !Sub "${Prefix}" ]
          - !Sub "${ProjectId}-${StageId}-${AWS::Region}-${AWS::AccountId}-src"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LoggingConfiguration: !If
      - HasLoggingBucket
      - DestinationBucketName: !Ref S3LogBucketName
        LogFilePrefix: !Join
          - "-"
          - - !If [UseS3BucketNameOrgPrefix, !Sub "${S3BucketNameOrgPrefix}-${Prefix}", !Sub "${Prefix}" ]
            - !Sub "${ProjectId}-${AWS::Region}-${AWS::AccountId}"
      - !Ref AWS::NoValue
      LifecycleConfiguration:
        Rules:
          - Id: "ExpireObjects"
            Status: "Enabled" # Enable only if you are going to use this LifecycleConfiguration
            Prefix: "uploads"
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
            NoncurrentVersionExpirationInDays: 7
          - Id: "MoveCurrentVersionToGlacier"
            Status: "Enabled" # Enable only if you are going to use this LifecycleConfiguration
            Prefix: "uploads"
            Transitions:
              - TransitionInDays: 30
                StorageClass: GLACIER
          - Id: "DeleteOldUploads"
            Status: "Disabled" # Enable only if you are going to use this LifecycleConfiguration
            Prefix: "uploads"
            ExpirationInDays: 365
      NotificationConfiguration:
        LambdaConfigurations:
          - Event: s3:ObjectCreated:*
            Function: !GetAtt SubmitJobFunction.Arn
            Filter:
              S3Key:
                Rules:
                  - Name: prefix
                    Value: "uploads/"
                  - Name: suffix
                    Value: ".mp4"

  # -- S3 Bucket Policy --

  VideoSourceBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref VideoSourceBucket
      PolicyDocument:
        Version: "2012-10-17"
        Id: SecurityPolicy
        Statement:
          - Sid: "DenyNonSecureTransportAccess"
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !Sub "arn:aws:s3:::${VideoSourceBucket}"
              - !Sub "arn:aws:s3:::${VideoSourceBucket}/*"
            Condition:
              Bool:
                "aws:SecureTransport": false

          - Sid: "EnforceBucketOwnerFullControlOnUploads"
            Effect: Allow
            Principal: "*"
            Action:
            - s3:PutObject
            Resource:
              - !Sub "arn:aws:s3:::${VideoSourceBucket}/uploads/*"
            Condition:
              StringEquals:
                "aws:SourceAccount": !Sub "${AWS::AccountId}"
                "s3:x-amz-acl": "bucket-owner-full-control"

  # -- Permissions allowing S3 to Execute Lambda --
  #    For gradual deployments to work properly, S3 needs permission to invoke both:
  #    1. $LATEST version (new code during deployment)
  #    2. :live alias (stable version during traffic shifting)
  #    Without both permissions, gradual deployments (in production) will fail with permission errors

  # Permission for S3 to invoke the $LATEST version of the Lambda function
  # This is used in all environments and during gradual deployments for new code
  S3LambdaPermission:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref SubmitJobFunction 
      Principal: s3.amazonaws.com
      SourceArn: !Join # Avoid circular reference
        - "-"
        - - !If [UseS3BucketNameOrgPrefix, !Sub "arn:aws:s3:::${S3BucketNameOrgPrefix}-${Prefix}", !Sub "arn:aws:s3:::${Prefix}" ]
          - !Sub "${ProjectId}-${StageId}-${AWS::Region}-${AWS::AccountId}-src"
      SourceAccount: !Ref AWS::AccountId

  # Permission for S3 to invoke the :live alias of the Lambda function
  # Only created in production where gradual deployments are enabled
  # During gradual deployment, traffic shifts from :live alias to $LATEST version
  S3LambdaPermissionLive:
    Type: "AWS::Lambda::Permission"
    Condition: IsProduction  # Only needed in production for gradual deployments
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${SubmitJobFunction}:live"
      Principal: s3.amazonaws.com
      SourceArn: !Join # Avoid circular reference
        - "-"
        - - !If [UseS3BucketNameOrgPrefix, !Sub "arn:aws:s3:::${S3BucketNameOrgPrefix}-${Prefix}", !Sub "arn:aws:s3:::${Prefix}" ]
          - !Sub "${ProjectId}-${StageId}-${AWS::Region}-${AWS::AccountId}-src"
      SourceAccount: !Ref AWS::AccountId


# =============================================================================
# OUTPUTS
# -----------------------------------------------------------------------------
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/outputs-section-structure.html
#
# Place anything interesting that you would like to quickly refer to in 
# your cloudformation OUTPUT section. Test URLs, direct links to resources, etc
#

Outputs:

  # -- CloudWatch Log Groups
  CloudWatchLambdaExecutionLogGroup:
    Description: "Cloud Watch Log Group for Lambda Execution Logs"
    Value: !Sub "https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#logStream:group=%2Faws%2Flambda%2F${SubmitJobFunction}"

  # -- Resource quick links
  LambdaWebConsole:
    Description: "Lambda Web Console"
    Value: !Sub "https://console.aws.amazon.com/lambda/home?region=${AWS::Region}#/functions/${SubmitJobFunction}?tab=code"

  ParameterStore:
    Description: "SSM Parameter Store"
    Value: !Sub "https://${AWS::Region}.console.aws.amazon.com/systems-manager/parameters/?region=${AWS::Region}&tab=Table#list_parameter_filters=Name:Contains:${ParameterStoreHierarchy}"

  SourceBucket:
    Description: "S3 Source Bucket"
    Value: !Sub "https://${AWS::Region}.console.aws.amazon.com/s3/buckets/${VideoSourceBucket}?region=${AWS::Region}&tab=objects"

  SourceBucketArn:
    Description: "S3 Source Bucket ARN"
    Value: !Sub "arn:aws:s3:::${VideoSourceBucket}"

  # VideoOutputBucketName:
  #   Description: "S3 Destination Bucket(s)"
  #   Value: !Join [", ", !Ref VideoOutputBucket]

  VideoOutputPrefixPath:
    Description: "S3 Destination Bucket Prefix"
    Value: !Ref VideoOutputPrefix